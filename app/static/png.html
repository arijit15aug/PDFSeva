<!-- app/static/png.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>To PNG</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .glass{background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);}
    .shine{
      background:
        radial-gradient(700px circle at 15% 10%, rgba(255,255,255,.35), transparent 55%),
        radial-gradient(800px circle at 85% 20%, rgba(255,255,255,.20), transparent 55%);
    }
    @keyframes borderShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .drop-wrap{position:relative;border-radius:28px;padding:2px;}
    .drop-wrap::before{
      content:"";position:absolute;inset:0;border-radius:28px;padding:2px;
      background:linear-gradient(120deg, rgba(34,211,238,.85), rgba(168,85,247,.85), rgba(236,72,153,.85));
      background-size:200% 200%;animation:borderShift 6s ease infinite;
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;mask-composite:exclude;
      opacity:.65;pointer-events:none;
      transition:opacity .2s ease;
    }
    .drop-inner{
      border-radius:26px;
      padding:34px;
      background:rgba(0,0,0,.15);
      border:1px solid rgba(255,255,255,.18);
      text-align:center;
      transition:transform .2s ease, background .2s ease, box-shadow .2s ease;
    }
    .drop-wrap.dragover::before{opacity:.98;}
    .drop-wrap.dragover .drop-inner{
      background:rgba(0,0,0,.20);
      transform:translateY(-1px);
      box-shadow:0 18px 60px rgba(0,0,0,.25);
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-fuchsia-600">
  <div class="min-h-screen shine">

    <header class="max-w-4xl mx-auto px-4 py-4">
      <div class="glass rounded-3xl px-5 py-4 flex justify-between items-center shadow-xl">
        <div class="text-white font-extrabold">To PNG</div>
        <a href="/" class="text-white/80 hover:text-white text-sm font-semibold">All tools</a>
      </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-10">
      <div class="glass rounded-[2rem] p-8 shadow-2xl border border-white/15">

        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
          <div>
            <h1 class="text-3xl md:text-4xl font-black text-white">Convert to PNG</h1>
            <p class="text-white/70 mt-2">PDF → PNG (ZIP if multi-page) and JPG/PNG/WebP → PNG.</p>
          </div>

          <!-- DPI -->
          <div id="dpiBox" class="glass rounded-2xl p-4 w-full md:w-80 border border-white/20">
            <div class="flex justify-between text-white text-sm font-semibold">
              <span>PNG quality (DPI)</span>
              <span id="dpiValue" class="font-black">144</span>
            </div>
            <input id="dpi" type="range" min="72" max="300" step="12" value="144" class="w-full mt-3 accent-white">
            <div class="flex justify-between text-xs text-white/60 mt-1">
              <span>72</span><span>144</span><span>216</span><span>300</span>
            </div>
            <p id="dpiNote" class="text-xs text-white/60 mt-2">
              Works for <span class="text-white/80 font-semibold">PDF → PNG</span> only.
            </p>
            <p class="text-xs text-white/55 mt-2">Recommended limit: max 25MB per file (Railway-safe).</p>
          </div>
        </div>

        <!-- DROPZONE -->
        <div id="dropWrap" class="drop-wrap mt-8">
          <label id="dropArea" class="drop-inner block cursor-pointer select-none">
            <input id="fileInput" type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.webp" />
            <div class="text-white text-2xl font-black">
              <span class="bg-white/15 px-2 py-1 rounded-lg">Drop</span> your file here
            </div>
            <div class="text-white/70 text-sm mt-1">or click to browse</div>

            <div class="mt-6 text-white/80 text-sm font-semibold">Selected file</div>
            <div id="fileLine" class="text-white/70 text-sm mt-2">No file selected</div>
          </label>
        </div>

        <!-- MESSAGE -->
        <div id="msg" class="hidden mt-6 rounded-2xl px-4 py-3 text-sm font-semibold"></div>

        <!-- BUTTONS -->
        <div class="flex flex-col sm:flex-row gap-3 mt-6">
          <button id="convertBtn"
                  class="bg-white text-purple-700 font-black px-6 py-3 rounded-2xl w-full shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
            Convert
          </button>

          <button id="resetBtn"
                  class="border border-white/30 text-white font-black px-6 py-3 rounded-2xl sm:w-40 w-full hover:bg-white/10 transition disabled:opacity-50 disabled:cursor-not-allowed">
            Reset
          </button>
        </div>

        <!-- PROGRESS -->
        <div id="progressWrap" class="hidden mt-6">
          <div class="flex justify-between text-white text-sm">
            <span id="status">Uploading…</span>
            <span id="percent">0%</span>
          </div>
          <div class="w-full h-2 bg-white/20 rounded mt-2 overflow-hidden">
            <div id="bar" class="h-2 bg-white w-0 transition-all"></div>
          </div>
        </div>

      </div>
    </main>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let selected = null;
  let activeXhr = null;

  // Railway-safe recommended limit
  const MAX_MB = 25;
  const MAX_BYTES = MAX_MB * 1024 * 1024;

  const fileInput = document.getElementById("fileInput");
  const dropWrap = document.getElementById("dropWrap");

  const convertBtn = document.getElementById("convertBtn");
  const resetBtn = document.getElementById("resetBtn");
  const fileLine = document.getElementById("fileLine");

  const dpiEl = document.getElementById("dpi");
  const dpiValue = document.getElementById("dpiValue");
  const dpiBox = document.getElementById("dpiBox");
  const dpiNote = document.getElementById("dpiNote");

  const progressWrap = document.getElementById("progressWrap");
  const statusEl = document.getElementById("status");
  const percentEl = document.getElementById("percent");
  const barEl = document.getElementById("bar");

  const msg = document.getElementById("msg");

  function showMsg(text, ok){
    msg.className = "mt-6 rounded-2xl px-4 py-3 text-sm font-semibold " +
      (ok
        ? "bg-emerald-400/20 text-emerald-50 border border-emerald-300/20"
        : "bg-red-400/20 text-red-50 border border-red-300/20");
    msg.textContent = text;
    msg.classList.remove("hidden");
  }
  function hideMsg(){
    msg.classList.add("hidden");
    msg.textContent = "";
  }

  function pretty(bytes){
    const u=["B","KB","MB","GB"];
    let i=0,v=bytes;
    while(v>=1024 && i<u.length-1){v/=1024;i++;}
    return `${v.toFixed(v>=10||i===0?0:1)} ${u[i]}`;
  }

  function setEnabled(hasFile){
    convertBtn.disabled = !hasFile;
    resetBtn.disabled = !hasFile;
  }

  function isAllowed(name){
    const n = (name||"").toLowerCase();
    return n.endsWith(".pdf") || n.endsWith(".jpg") || n.endsWith(".jpeg") || n.endsWith(".png") || n.endsWith(".webp");
  }

  function setFile(f){
    hideMsg();
    selected = f || null;

    if(!selected){
      fileLine.textContent = "No file selected";
      setEnabled(false);
      dpiBox.style.opacity = "1";
      dpiEl.disabled = false;
      dpiNote.innerHTML = 'Works for <span class="text-white/80 font-semibold">PDF → PNG</span> only.';
      return;
    }

    if(!isAllowed(selected.name)){
      selected = null;
      fileLine.textContent = "No file selected";
      setEnabled(false);
      showMsg("Only PDF, JPG, JPEG, PNG, WEBP are allowed.", false);
      return;
    }

    if(selected.size > MAX_BYTES){
      selected = null;
      fileLine.textContent = "No file selected";
      setEnabled(false);
      showMsg(`File too large. Max ${MAX_MB}MB for Railway safety.`, false);
      return;
    }

    fileLine.textContent = `${selected.name} • ${pretty(selected.size)}`;
    setEnabled(true);

    const isPdf = selected.name.toLowerCase().endsWith(".pdf");
    dpiBox.style.opacity = isPdf ? "1" : "0.45";
    dpiEl.disabled = !isPdf;
    dpiNote.innerHTML = isPdf
      ? 'Works for <span class="text-white/80 font-semibold">PDF → PNG</span> only.'
      : 'DPI is ignored for images.';
  }

  // DPI display
  dpiEl.addEventListener("input", () => dpiValue.textContent = dpiEl.value);

  // Click browse
  fileInput.addEventListener("change", () => setFile(fileInput.files?.[0]));

  // Drag & drop
  const dropArea = document.getElementById("dropArea");
  dropArea.addEventListener("dragover", (e) => { e.preventDefault(); dropWrap.classList.add("dragover"); });
  dropArea.addEventListener("dragleave", () => dropWrap.classList.remove("dragover"));
  dropArea.addEventListener("drop", (e) => {
    e.preventDefault();
    dropWrap.classList.remove("dragover");
    setFile(e.dataTransfer.files?.[0]);
  });

  // Reset
  resetBtn.addEventListener("click", () => {
    hideMsg();
    if(activeXhr){ activeXhr.abort(); activeXhr = null; }
    fileInput.value = "";
    progressWrap.classList.add("hidden");
    barEl.style.width = "0%";
    percentEl.textContent = "0%";
    statusEl.textContent = "Uploading…";
    convertBtn.textContent = "Convert";
    setFile(null);
  });

  function getFilenameFromDisposition(disposition){
    if(!disposition) return null;
    const m = disposition.match(/filename\*=UTF-8''([^;]+)|filename="([^"]+)"/i);
    const raw = decodeURIComponent(m?.[1] || m?.[2] || "");
    return raw || null;
  }

  async function readErrorBlob(blob){
    try{
      const text = await blob.text();
      try{
        const j = JSON.parse(text);
        if(j && typeof j.detail === "string") return j.detail;
      }catch(_){}
      return text || "Request failed";
    }catch(_){
      return "Request failed";
    }
  }

  // Convert
  convertBtn.addEventListener("click", () => {
    if(!selected) return;

    hideMsg();
    convertBtn.disabled = true;
    resetBtn.disabled = true;
    convertBtn.textContent = "Converting…";

    progressWrap.classList.remove("hidden");
    statusEl.textContent = "Uploading…";
    percentEl.textContent = "0%";
    barEl.style.width = "0%";

    const fd = new FormData();
    fd.append("file", selected);
    fd.append("dpi", dpiEl.value); // backend clamps

    const xhr = new XMLHttpRequest();
    activeXhr = xhr;
    xhr.open("POST", "/convert/to-png", true);
    xhr.responseType = "blob";

    xhr.upload.onprogress = (e) => {
      if(!e.lengthComputable) return;
      const pct = Math.round((e.loaded / e.total) * 100);
      percentEl.textContent = pct + "%";
      barEl.style.width = pct + "%";
      statusEl.textContent = pct < 100 ? "Uploading…" : "Converting…";
    };

    xhr.onerror = () => {
      activeXhr = null;
      showMsg("Network error", false);
      convertBtn.disabled = false;
      resetBtn.disabled = false;
      convertBtn.textContent = "Convert";
    };

    xhr.onabort = () => {
      activeXhr = null;
      showMsg("Cancelled", false);
      convertBtn.disabled = false;
      resetBtn.disabled = false;
      convertBtn.textContent = "Convert";
    };

    xhr.onload = async () => {
      activeXhr = null;

      if(xhr.status >= 200 && xhr.status < 300){
        const blob = xhr.response;
        const url = URL.createObjectURL(blob);

        const disp = xhr.getResponseHeader("Content-Disposition");
        let fname = getFilenameFromDisposition(disp);

        if(!fname){
          const base = selected.name.replace(/\.[^/.]+$/, "");
          fname = selected.name.toLowerCase().endsWith(".pdf") ? `${base}-png.zip` : `${base}.png`;
        }

        const a = document.createElement("a");
        a.href = url;
        a.download = fname;
        document.body.appendChild(a);
        a.click();
        a.remove();

        setTimeout(() => URL.revokeObjectURL(url), 1000);

        statusEl.textContent = "Done ✅";
        showMsg("Converted successfully. Download started.", true);
      } else {
        const msgText = await readErrorBlob(xhr.response);
        showMsg("Convert failed: " + msgText, false);
      }

      convertBtn.disabled = false;
      resetBtn.disabled = false;
      convertBtn.textContent = "Convert";
    };

    xhr.send(fd);
  });

  // init
  setFile(null);
  setEnabled(false);
});
</script>

</body>
</html>